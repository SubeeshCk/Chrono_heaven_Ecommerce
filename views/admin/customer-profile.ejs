<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Admin dashboard</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="" />
  <meta property="og:type" content="" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="" />
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/logo-title.png" />
  <!-- Template CSS -->
  <link href="/adminAssets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
</head>

<body>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="index.html" class="brand-wrap">
        <img src="/userAssets/images/icons/logo-01.png" class="logo" alt="Nest Dashboard" />
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item active">
          <a class="menu-link" href="/admin/Dashboard">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Categories</span>
          </a>
          <div class="submenu">
            <a href="/admin/categories">Categories</a>
          </div>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
          <div class="submenu">
            <a href="/admin/products">Products list</a>
            <a href="/admin/products/add-products">Add product</a>
          </div>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
          <div class="submenu">
            <a href="/admin/orders">Orders</a>
          </div>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link" href="/admin/users">
            <i class="icon material-icons md-person"></i>
            <span class="text">Customers</span>
          </a>
          <div class="submenu active">
            <a href="/admin/customers">Customers</a>
          </div>
        </li>
        <li class="menu-item has-submenu ">
          <a class="menu-link" href="#">
              <i class="icon material-icons md-person"></i>
              <span class="text">Offers</span>
          </a>
          <div class="submenu">
              <a href="/admin/addCategoryOffer">Category offers</a>
              <a href="/admin/addProductOffer">Product offers</a>
          </div>
      </li>
        <br />
        <br />
    </nav>
  </aside>

  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search">
        <form class="searchform">
          <div class="input-group">
            <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
            <button class="btn btn-light bg" type="button"><i class="material-icons md-search"></i></button>
          </div>
          <datalist id="search_terms">
            <option value="Products"></option>
            <option value="New orders"></option>
            <option value="Apple iphone"></option>
            <option value="Ahmed Hassan"></option>
          </datalist>
        </form>
      </div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
            class="material-icons md-apps"></i></button>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link btn-icon" href="#">
              <i class="material-icons md-notifications animation-shake"></i>
              <span class="badge rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i
                class="material-icons md-public"></i></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
              <a class="dropdown-item text-brand" href="#"><img src="/adminAssets/imgs/theme/flag-us.png"
                  alt="English" />English</a>
              <a class="dropdown-item" href="#"><img src="/adminAssets/imgs/theme/flag-fr.png"
                  alt="Français" />Français</a>
              <a class="dropdown-item" href="#"><img src="/adminAssets/imgs/theme/flag-jp.png" alt="Français" />日本語</a>
              <a class="dropdown-item" href="#"><img src="/adminAssets/imgs/theme/flag-cn.png" alt="Français" />中国人</a>
            </div>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false">
              <img class="img-xs rounded-circle" src="/adminAssets/imgs/people/avatar-2.png" alt="User" /></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit
                Profile</a>
              <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account
                Settings</a>
              <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
              <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
              <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help
                center</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-danger" href="/admin/logOut"><i
                  class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </header>

    <section class="content-main">
      <div class="content-header">
        <a href="/admin/customers"><i class="material-icons md-arrow_back"></i> Go back </a>
      </div>
      <div class="card mb-4">
        <div class="card-header bg-brand-2" style="height: 150px"></div>
        <div class="card-body">
          <div class="row">
            <!-- <div class="col-xl col-lg flex-grow-0" style="flex-basis: 230px">
                    <div class="img-thumbnail shadow w-100 bg-white position-relative text-center" style="height: 190px; width: 200px; margin-top: -120px">
                        <img src="<%= customer.image %>" class="center-xy img-fluid" alt="Customer Avatar" />
                    </div>
                </div> -->
            <div class="col-xl col-lg">
              <h3>
                <%= customer.name %>
              </h3>
              <p>Email: <%= customer.email %>
              </p>
              <p>Mobile: <%= customer.mobile %>
              </p>
            </div>
            <div class="col-xl-4 text-md-end">
              <select class="form-select w-auto d-inline-block"
                onchange="handleActionChange(this, '<%= customer._id %>', '<%= customer.block %>')">
                <option value="">Actions</option>
                <% if (customer.block) { %>
                  <option value="unblock">Unblock User</option>
                  <% } else { %>
                    <option value="block">Block User</option>
                    <% } %>
                      <option value="message">Send Message</option>
              </select>
              <a href="#" class="btn btn-primary"> View Orders <i class="material-icons md-launch"></i> </a>
            </div>
          </div>
          <hr class="my-4" />
          <div class="row g-4">
            <div class="col-md-12 col-lg-4 col-xl-2">
              <article class="box">
                <p class="mb-0 text-muted">Total Purchases:</p>
                <h5 class="text-success">
                  <%= customer.totalPurchases %>
                </h5>
                <p class="mb-0 text-muted">Spent:</p>
                <h5 class="text-success mb-0">$<%= customer.totalSpent %>
                </h5>
              </article>
            </div>
            <div class="col-sm-6 col-lg-4 col-xl-3">
              <h6>Contacts</h6>
              <p>
                Name: <%= customer.name %> <br />
                  Email: <%= customer.email %> <br />
                    Phone: <%= customer.mobile %>
              </p>
            </div>
            <div class="col-sm-6 col-lg-4 col-xl-3">
              <h6>Address</h6>
              <p><% if (addresses && addresses.length > 0) { %>
                     <% addresses.forEach(address => { %>
                     Type: <%= address.addresstype %><br>
                     <%= address.name %>,<%= address.address %>, <%= address.locality %>, <%= address.city %>, <%= address.pincode %>
                      <% }) %>
                  <% } else { %>
                      <li class="list-group-item" style="color: #000; padding: 20px;">No addresses found.</li>
                  <% } %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="/adminAssets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/adminAssets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/adminAssets/js/vendors/select2.min.js"></script>
    <script src="/adminAssets/js/vendors/perfect-scrollbar.js"></script>
    <script src="/adminAssets/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/adminAssets/js/main.js?v=1.1" type="text/javascript"></script>

    <script>
      function setLoading(isLoading) {
        const actionSelect = document.querySelector('select.form-select');
        actionSelect.disabled = isLoading;
      }

      function handleActionChange(selectElement, userId, isBlocked) {
        const action = selectElement.value;
        const isBlockedBool = isBlocked === "true";

        console.log(`Action selected: ${action}, UserID: ${userId}, IsBlocked: ${isBlockedBool}`);

        if (action === "block" && !isBlockedBool) {
          handleBlock(userId);
        } else if (action === "unblock" && isBlockedBool) {
          handleUnblock(userId);
        } else if (action === "message") {
          swal("Message", "This feature is not yet implemented", "info");
        } else {
          console.log("No action taken: current state doesn't match the selected action");
        }

        selectElement.value = "";
      }

      async function handleBlock(userId) {
        const confirmation = await confirmAction("block");
        if (confirmation) {
          setLoading(true);
          console.log(`Initiating block request for user: ${userId}`);
          try {
            const response = await fetch("/admin/customers/block", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId }),
            });

            const data = await response.json();
            console.log(`Server response for blocking user ${userId}:`, data);

            if (response.ok) {
              swal("Success", data.message || "User blocked successfully", "success")
                .then(() => {
                  location.reload();
                });
            } else {
              swal("Error", data.message || "Failed to block user", "error");
            }
          } catch (error) {
            console.error(`Error in block request for user ${userId}:`, error);
            swal("Error", "An error occurred while blocking the user", "error");
          } finally {
            setLoading(false);
          }
        }
      }

      async function handleUnblock(userId) {
        const confirmation = await confirmAction("unblock");
        if (confirmation) {
          setLoading(true);
          console.log(`Initiating unblock request for user: ${userId}`);
          try {
            const response = await fetch("/admin/customers/unblock", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId }),
            });

            const data = await response.json();
            console.log(`Server response for unblocking user ${userId}:`, data);

            if (response.ok) {
              swal("Success", data.message || "User unblocked successfully", "success")
                .then(() => {
                  location.reload();
                });
            } else {
              swal("Error", data.message || "Failed to unblock user", "error");
            }
          } catch (error) {
            console.error(`Error in unblock request for user ${userId}:`, error);
            swal("Error", "An error occurred while unblocking the user", "error");
          } finally {
            setLoading(false);
          }
        }
      }

      async function confirmAction(action) {
        const result = await swal({
          title: `Are you sure you want to ${action} this user?`,
          icon: "warning",
          buttons: true,
          dangerMode: true,
        });
        return result;
      }
    </script>

</body>

</html>